<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fischer-Verein Arbon - News</title>
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container nav-container">
      <a href="index.html" class="logo">
        <img src="assets/img/logo-fv-arbon.png" alt="Logo Fischer-Verein Arbon">
      </a>

      <div style="text-align: center; flex: 1; padding: 0 2rem;">
        <h1 style="margin: 0; font-size: 1.8rem; color: var(--color-text); line-height: 1.3;">Fischer-Verein Arbon</h1>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.95rem; color: var(--color-muted);">Gemeinschaft, Natur und Fischerei am Bodensee ‚Äì seit 1899.</p>
      </div>

      <button class="nav-toggle" aria-label="Men√º √∂ffnen">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <nav class="main-nav">
        <ul>
          <li><a href="index.html">Startseite</a></li>
          <li class="has-dropdown">
            <a href="verein.html">Verein</a>
            <ul class="dropdown-menu">
              <li><a href="beitritt.html">Beitritt</a></li>
              <li><a href="leitsatz.html">Leitsatz</a></li>
              <li><a href="vorstand.html">Vorstand</a></li>
            </ul>
          </li>
          <li><a href="fischerhaus.html">Fischerhaus</a></li>
          <li><a href="jungfischer.html">Jungfischer</a></li>
          <li><a href="sana.html">SANA-Kurs</a></li>
          <li><a href="galerie.html">Galerie</a></li>
          <li><a href="news.html">News</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="news-page container" style="padding: 2rem 1rem 3rem;">
    <h1>News & Aktuelles</h1>
    <p>Hier findest du aktuelle Meldungen und Ank√ºndigungen vom Fischer-Verein Arbon.</p>

    <div id="category-filters" class="news-filters" style="margin: 1rem 0; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
    <div id="news-container" class="news-container" style="display: grid; gap: 2rem;"></div>
  </main>

  <!-- Modal/Lightbox f√ºr vollst√§ndige News -->
  <div id="news-modal" class="news-modal">
    <div class="news-modal-content">
      <button class="news-modal-close" aria-label="Schlie√üen">&times;</button>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Bild-Lightbox f√ºr Galerie -->
  <div id="image-lightbox" class="image-lightbox">
    <button class="lightbox-close" aria-label="Schlie√üen">&times;</button>
    <button class="lightbox-nav prev" aria-label="Vorheriges Bild">‚ùÆ</button>
    <img id="lightbox-img" src="" alt="">
    <p id="lightbox-caption"></p>
    <button class="lightbox-nav next" aria-label="N√§chstes Bild">‚ùØ</button>
  </div>

  <script>
    let allNewsData = [];
    let currentLightboxImages = [];
    let currentLightboxIndex = 0;

    function formatDate(isoDateStr) {
      if (!isoDateStr) return "";
      const d = new Date(isoDateStr);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }

    function markdownToHtml(markdown) {
      if (!markdown) return "";
      return markdown
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #0047ab;">$1</a>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    }

    async function loadNews() {
      try {
        const response = await fetch('https://api.github.com/repos/thomasbrauer777/fv-arbon-website/contents/content/news');
        const files = await response.json();
        
        const newsPromises = files
          .filter(file => file.name.endsWith('.md'))
          .map(async file => {
            const content = await fetch(file.download_url);
            const text = await content.text();
            return parseMarkdownFile(text, file.name);
          });

        allNewsData = await Promise.all(newsPromises);
        const publishedNews = allNewsData.filter(n => n.published !== false);
        
        publishedNews.sort((a, b) => new Date(b.date) - new Date(a.date));

        displayNews(publishedNews);
      } catch (error) {
        console.error("Fehler beim Laden:", error);
        document.getElementById("news-container").innerHTML = "<p>‚ùå Fehler beim Laden der News. Bitte sp√§ter erneut versuchen.</p>";
      }
    }

    function parseMarkdownFile(text, filename) {
      const lines = text.split('\n');
      const frontmatter = {};
      let inFrontmatter = false;
      let bodyLines = [];
      let inGallery = false;
      let galleryItems = [];
      let currentGalleryItem = {};

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (line.trim() === '---') {
          if (!inFrontmatter) {
            inFrontmatter = true;
          } else {
            inFrontmatter = false;
          }
          continue;
        }

        if (inFrontmatter) {
          // Check for gallery start
          if (line.match(/^gallery:\s*$/)) {
            inGallery = true;
            continue;
          }

          // Parse gallery items
          if (inGallery) {
            if (line.match(/^\s+-\s*src:/)) {
              if (currentGalleryItem.src) {
                galleryItems.push(currentGalleryItem);
              }
              currentGalleryItem = { src: line.match(/src:\s*(.+)/)[1].trim() };
            } else if (line.match(/^\s+caption:/)) {
              const captionMatch = line.match(/caption:\s*(.+)/);
              if (captionMatch) {
                currentGalleryItem.caption = captionMatch[1].trim().replace(/['"]/g, '');
              }
            } else if (!line.match(/^\s/) && line.includes(':')) {
              // End of gallery, save last item
              if (currentGalleryItem.src) {
                galleryItems.push(currentGalleryItem);
              }
              inGallery = false;
              // Process this line as normal frontmatter
              const match = line.match(/^(\w+):\s*(.+)$/);
              if (match) {
                let value = match[2].trim();
                if (value.startsWith('"') && value.endsWith('"')) {
                  value = value.slice(1, -1);
                }
                frontmatter[match[1]] = value;
              }
            }
            continue;
          }

          const match = line.match(/^(\w+):\s*(.+)$/);
          if (match) {
            const key = match[1];
            let value = match[2].trim();
            if (value.startsWith('"') && value.endsWith('"')) {
              value = value.slice(1, -1);
            }
            frontmatter[key] = value;
          }
        } else if (lines[i].trim()) {
          bodyLines.push(lines[i]);
        }
      }

      // Don't forget last gallery item
      if (currentGalleryItem.src) {
        galleryItems.push(currentGalleryItem);
      }

      return {
        title: frontmatter.title || '',
        date: frontmatter.date || '',
        category: frontmatter.category || 'Sonstiges',
        teaser: frontmatter.teaser || '',
        body: bodyLines.join('\n'),
        image: frontmatter.image || '',
        gallery: galleryItems,
        url: frontmatter.url || '',
        published: frontmatter.published !== 'false'
      };
    }

    function displayNews(newsData) {
      const container = document.getElementById("news-container");
      const filters = document.getElementById("category-filters");
      const categories = [...new Set(newsData.map(n => n.category).filter(Boolean))];

      filters.innerHTML = '<button onclick="filterNews(\'Alle\')" class="news-filter-button active">Alle</button>' +
        categories.map(cat => `<button onclick="filterNews('${cat}')" class="news-filter-button">${cat}</button>`).join("");

      window.filterNews = function (category) {
        const cards = document.querySelectorAll(".news-card");
        const buttons = document.querySelectorAll(".news-filter-button");
        
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        cards.forEach(card => {
          card.style.display = (category === "Alle" || card.dataset.category === category) ? "flex" : "none";
        });
      }

      newsData.forEach((news, index) => {
        const card = document.createElement("article");
        card.className = "news-card";
        card.dataset.category = news.category;
        card.dataset.index = index;
        card.style.background = "#e0f0ff";
        card.style.color = "#003366";
        card.style.borderRadius = "10px";
        card.style.overflow = "hidden";
        card.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.height = "100%";
        card.style.cursor = "pointer";
        card.style.transition = "transform 0.2s, box-shadow 0.2s";

        card.addEventListener('mouseenter', () => {
          card.style.transform = "translateY(-5px)";
          card.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
        });

        card.addEventListener('mouseleave', () => {
          card.style.transform = "translateY(0)";
          card.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";
        });

        card.addEventListener('click', () => openNewsModal(news));

        if (news.image) {
          const img = document.createElement("img");
          img.src = news.image;
          img.alt = news.title;
          img.style.width = "100%";
          img.style.height = "200px";
          img.style.objectFit = "cover";
          card.appendChild(img);
        }

        const body = document.createElement("div");
        body.style.padding = "1rem";
        body.style.flex = "1";
        body.style.display = "flex";
        body.style.flexDirection = "column";

        const small = document.createElement("small");
        small.style.color = "#005288";
        small.textContent = `${formatDate(news.date)} ‚Äì ${news.category}`;
        body.appendChild(small);

        const title = document.createElement("h2");
        title.style.margin = "0.3rem 0 0.5rem";
        title.textContent = news.title;
        body.appendChild(title);

        const teaser = document.createElement("p");
        teaser.textContent = news.teaser;
        body.appendChild(teaser);

        // Bildanzahl anzeigen wenn Galerie vorhanden
        const imageCount = (news.image ? 1 : 0) + (news.gallery ? news.gallery.length : 0);
        if (imageCount > 1) {
          const imgCount = document.createElement("span");
          imgCount.style.fontSize = "0.85rem";
          imgCount.style.color = "#005288";
          imgCount.textContent = `üì∑ ${imageCount} Bilder`;
          body.appendChild(imgCount);
        }

        const readMore = document.createElement("span");
        readMore.style.marginTop = "auto";
        readMore.style.color = "#0047ab";
        readMore.style.fontWeight = "bold";
        readMore.textContent = "Weiterlesen ‚Üí";
        body.appendChild(readMore);

        card.appendChild(body);
        container.appendChild(card);
      });

      allNewsData = newsData;
    }

    function openNewsModal(news) {
      const modal = document.getElementById("news-modal");
      const modalBody = document.getElementById("modal-body");

      // Alle Bilder sammeln (Titelbild + Galerie)
      let allImages = [];
      if (news.image) {
        allImages.push({ src: news.image, caption: '' });
      }
      if (news.gallery && news.gallery.length > 0) {
        allImages = allImages.concat(news.gallery);
      }

      let html = '';

      // Titelbild
      if (news.image) {
        html += `<img src="${news.image}" alt="${news.title}" class="modal-main-image" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 10px; margin-bottom: 1.5rem; cursor: pointer;" onclick="openImageLightbox(0)">`;
      }

      html += `
        <small style="color: #005288; font-size: 0.9rem;">${formatDate(news.date)} ‚Äì ${news.category}</small>
        <h2 style="margin: 0.5rem 0 1rem; color: #003366;">${news.title}</h2>
        <p style="color: #003366; font-size: 1.1rem; margin-bottom: 1rem;"><strong>${news.teaser}</strong></p>
      `;

      if (news.body) {
        html += `<div style="color: #003366; line-height: 1.6;"><p>${markdownToHtml(news.body)}</p></div>`;
      }

      // Galerie anzeigen
      if (allImages.length > 1) {
        html += `
          <div class="news-gallery" style="margin-top: 2rem;">
            <h3 style="color: #003366; margin-bottom: 1rem;">üì∑ Bilder (${allImages.length})</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem;">
        `;
        
        allImages.forEach((img, index) => {
          html += `
            <div style="cursor: pointer;" onclick="openImageLightbox(${index})">
              <img src="${img.src}" alt="${img.caption || ''}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              ${img.caption ? `<p style="font-size: 0.75rem; color: #005288; margin: 0.25rem 0 0; text-align: center;">${img.caption}</p>` : ''}
            </div>
          `;
        });
        
        html += `</div></div>`;
      }

      if (news.url) {
        html += `<a href="${news.url}" target="_blank" style="display: inline-block; margin-top: 1.5rem; padding: 0.7rem 1.5rem; background: #0047ab; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">Mehr erfahren ‚Üí</a>`;
      }

      modalBody.innerHTML = html;
      modal.style.display = "flex";
      document.body.style.overflow = "hidden";

      // Bilder f√ºr Lightbox speichern
      currentLightboxImages = allImages;
    }

    function closeNewsModal() {
      const modal = document.getElementById("news-modal");
      modal.style.display = "none";
      document.body.style.overflow = "auto";
    }

    // Bild-Lightbox Funktionen
    function openImageLightbox(index) {
      currentLightboxIndex = index;
      const lightbox = document.getElementById("image-lightbox");
      const img = document.getElementById("lightbox-img");
      const caption = document.getElementById("lightbox-caption");
      
      img.src = currentLightboxImages[index].src;
      caption.textContent = currentLightboxImages[index].caption || '';
      
      lightbox.style.display = "flex";
    }

    function closeImageLightbox() {
      document.getElementById("image-lightbox").style.display = "none";
    }

    function nextLightboxImage() {
      currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
      document.getElementById("lightbox-img").src = currentLightboxImages[currentLightboxIndex].src;
      document.getElementById("lightbox-caption").textContent = currentLightboxImages[currentLightboxIndex].caption || '';
    }

    function prevLightboxImage() {
      currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
      document.getElementById("lightbox-img").src = currentLightboxImages[currentLightboxIndex].src;
      document.getElementById("lightbox-caption").textContent = currentLightboxImages[currentLightboxIndex].caption || '';
    }

    // Event Listeners
    document.querySelector('.news-modal-close').addEventListener('click', closeNewsModal);
    
    document.getElementById('news-modal').addEventListener('click', (e) => {
      if (e.target.id === 'news-modal') {
        closeNewsModal();
      }
    });

    document.querySelector('#image-lightbox .lightbox-close').addEventListener('click', closeImageLightbox);
    document.querySelector('#image-lightbox .next').addEventListener('click', nextLightboxImage);
    document.querySelector('#image-lightbox .prev').addEventListener('click', prevLightboxImage);

    document.getElementById('image-lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'image-lightbox') {
        closeImageLightbox();
      }
    });

    document.addEventListener('keydown', (e) => {
      const newsModal = document.getElementById('news-modal');
      const imageLightbox = document.getElementById('image-lightbox');
      
      if (imageLightbox.style.display === 'flex') {
        if (e.key === 'Escape') closeImageLightbox();
        if (e.key === 'ArrowRight') nextLightboxImage();
        if (e.key === 'ArrowLeft') prevLightboxImage();
      } else if (newsModal.style.display === 'flex') {
        if (e.key === 'Escape') closeNewsModal();
      }
    });

    loadNews();
  </script>

  <style>
    .news-filter-button {
      border: 1px solid #ccc;
      background: #f8f8f8;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
    }
    .news-filter-button:hover {
      background: #e0e0e0;
    }
    .news-filter-button.active {
      background: #0047ab;
      color: white;
      border-color: #0047ab;
    }
    .news-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    /* Modal/Lightbox Styles */
    .news-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .news-modal-content {
      background: #e0f0ff;
      padding: 2rem;
      border-radius: 15px;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      margin: 1rem;
      animation: slideIn 0.3s;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .news-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-size: 2rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #003366;
      line-height: 1;
      transition: all 0.2s;
      z-index: 10;
    }

    .news-modal-close:hover {
      background: white;
      transform: rotate(90deg);
    }

    /* Bild-Lightbox */
    .image-lightbox {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .image-lightbox img {
      max-width: 90%;
      max-height: 80vh;
      border-radius: 8px;
    }

    .image-lightbox p {
      color: white;
      text-align: center;
      margin-top: 1rem;
      font-size: 1rem;
    }

    .image-lightbox .lightbox-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: white;
      font-size: 2.5rem;
      cursor: pointer;
    }

    .image-lightbox .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 2rem;
      padding: 1rem;
      cursor: pointer;
      border-radius: 50%;
    }

    .image-lightbox .lightbox-nav:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .image-lightbox .prev {
      left: 2rem;
    }

    .image-lightbox .next {
      right: 2rem;
    }

    @media (max-width: 768px) {
      .news-modal-content {
        padding: 1.5rem;
        margin: 0.5rem;
        max-height: 95vh;
      }

      .image-lightbox .lightbox-nav {
        padding: 0.75rem;
        font-size: 1.5rem;
      }

      .image-lightbox .prev {
        left: 0.5rem;
      }

      .image-lightbox .next {
        right: 0.5rem;
      }
    }
  </style>

  <footer class="site-footer">
    <div class="container footer-content">
      <div>
        <h3>Fischer-Verein Arbon</h3>
        <p>
          Bahnhofstrasse 11<br>
          9320 Arbon<br>
          Schweiz
        </p>
        <p>
          <a href="mailto:vorstand@fv-arbon.ch">vorstand@fv-arbon.ch</a>
        </p>
      </div>
      <div>
        <h4>Links</h4>
        <ul>
          <li><a href="verein.html#jahreskalender">Jahreskalender</a></li>
          <li><a href="verein.html#statuten">Statuten</a></li>
          <li><a href="datenschutz.html">Datenschutzerkl√§rung</a></li>
        </ul>
      </div>
      <div>
        <h4>Folgen</h4>
        <div class="social-links" style="margin-top: 0.5rem; display: flex; gap: 1rem;">
          <a href="https://www.facebook.com/profile.php?id=61588551786706" target="_blank" rel="noopener noreferrer" title="Facebook">
            <svg style="width: 24px; height: 24px; fill: white;" viewBox="0 0 24 24"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg>
          </a>
          <a href="https://www.instagram.com/fischervereinarbon" target="_blank" rel="noopener noreferrer" title="Instagram">
            <svg style="width: 24px; height: 24px; fill: white;" viewBox="0 0 24 24"><path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8A3.6 3.6 0 0 0 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6A3.6 3.6 0 0 0 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>
          </a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; <span id="year"></span> Fischer-Verein Arbon. Alle Rechte vorbehalten.</p>
    </div>
  </footer>

  <script src="assets/js/main.js"></script>
</body>
</html>
